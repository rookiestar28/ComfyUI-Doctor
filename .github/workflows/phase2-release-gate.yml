name: Phase 2 Release Gate

on:
  push:
    branches:
      - main
      - dev
      - 'release/**'
    paths:
      # Trigger on Phase 2 critical files
      - 'pipeline/**/*.py'
      - 'sanitizer.py'
      - 'outbound.py'
      - 'config.py'
      - '__init__.py'
      - 'tests/test_plugins_security.py'
      - 'tests/test_metadata_contract.py'
      - 'tests/test_pipeline_dependency_policy.py'
      - 'tests/test_outbound_payload_safety.py'
      - 'web/**/*.js'
      - 'tests/e2e/**/*.js'
      - '.github/workflows/phase2-release-gate.yml'
  pull_request:
    branches:
      - main
      - dev
    paths:
      - 'pipeline/**/*.py'
      - 'sanitizer.py'
      - 'outbound.py'
      - 'config.py'
      - '__init__.py'
      - 'tests/test_plugins_security.py'
      - 'tests/test_metadata_contract.py'
      - 'tests/test_pipeline_dependency_policy.py'
      - 'tests/test_outbound_payload_safety.py'
      - 'web/**/*.js'
      - 'tests/e2e/**/*.js'
      - '.github/workflows/phase2-release-gate.yml'
  workflow_dispatch:

jobs:
  phase2-python-gate:
    name: Phase 2 Python Security & Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            pytest.ini

      - name: Install dependencies
        run: |
          pip install pytest jsonschema

      - name: Run Plugin Security Suite
        run: |
          pytest -q tests/test_plugins_security.py --tb=short
        timeout-minutes: 2

      - name: Run Metadata Contract Suite
        run: |
          pytest -q tests/test_metadata_contract.py --tb=short
        timeout-minutes: 1

      - name: Run Dependency Policy Suite
        run: |
          pytest -q tests/test_pipeline_dependency_policy.py --tb=short
        timeout-minutes: 1

      - name: Run Outbound Payload Safety Suite
        run: |
          pytest -q tests/test_outbound_payload_safety.py --tb=short
        timeout-minutes: 1

      - name: Summary
        if: success()
        run: |
          echo "✅ Phase 2 Python Gate Passed"
          echo "- Plugin security: PASS"
          echo "- Metadata contract: PASS"
          echo "- Dependency policy: PASS"
          echo "- Outbound payload safety: PASS"

  phase2-e2e-gate:
    name: Phase 2 E2E Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Set up Python 3.10 (for HTTP server)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install npm dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run E2E tests
        run: npm test
        env:
          CI: true
        timeout-minutes: 8

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/
          retention-days: 7

      - name: Summary
        if: success()
        run: |
          echo "✅ Phase 2 E2E Gate Passed"
          echo "- Preact loader: PASS"
          echo "- Settings UI: PASS"
          echo "- Statistics UI: PASS"
          echo "- Sidebar UI: PASS"

  phase2-gate-complete:
    name: Phase 2 Gate Complete
    runs-on: ubuntu-latest
    needs: [phase2-python-gate, phase2-e2e-gate]
    if: always()

    steps:
      - name: Check gate status
        run: |
          if [[ "${{ needs.phase2-python-gate.result }}" == "success" ]] && [[ "${{ needs.phase2-e2e-gate.result }}" == "success" ]]; then
            echo "✅ Phase 2 Release Gate: ALL CHECKS PASSED"
            echo ""
            echo "Security & Governance:"
            echo "  ✅ Plugin security (10 tests)"
            echo "  ✅ Metadata contract (1 test)"
            echo "  ✅ Dependency policy (2 tests)"
            echo "  ✅ Outbound payload safety (4 tests)"
            echo ""
            echo "Frontend Regression:"
            echo "  ✅ E2E tests (61 tests)"
            echo ""
            echo "This change is safe to merge."
            exit 0
          else
            echo "❌ Phase 2 Release Gate: FAILED"
            echo ""
            echo "Python Gate: ${{ needs.phase2-python-gate.result }}"
            echo "E2E Gate: ${{ needs.phase2-e2e-gate.result }}"
            echo ""
            echo "Please fix the failing checks before merging."
            exit 1
          fi
